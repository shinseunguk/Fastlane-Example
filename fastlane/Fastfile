# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

fastlane_require 'active_support'
fastlane_require 'active_support/core_ext/time'
fastlane_require 'dotenv'

#âœ… ìƒìˆ˜

SLACK_URL = ENV['SLACK_URL']

KEYCHAIN_NAME = ENV['KEYCHAIN_NAME']
KEYCHAIN_PASSWORD = ENV['KEYCHAIN_PASSWORD']

APP_IDENTIFIER = ENV['APP_IDENTIFIER']

MATCH_GIT_BASIC_AUTHORIZATION = ENV['MATCH_GIT_BASIC_AUTHORIZATION']

APP_STORE_CONNECT_API_KEY_KEY_ID = ENV['APP_STORE_CONNECT_API_KEY_KEY_ID']
APP_STORE_CONNECT_API_KEY_ISSUER_ID = ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID']
APP_STORE_CONNECT_API_KEY_CONTENT = ENV['APP_STORE_CONNECT_API_KEY_CONTENT']

GIT_PERSONAL_TOKEN = ENV['GIT_PERSONAL_TOKEN']

TEAM_ID = ENV['TEAM_ID']


default_platform(:ios)

platform :ios do
  lane :upload_testflight do
    begin
      # âœ… App Store Connect API í‚¤ ì„¤ì •
      # API í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•˜ì—¬ App Store Connectì— ì ‘ê·¼
      app_store_connect_api_key(
        key_id: "#{APP_STORE_CONNECT_API_KEY_KEY_ID}",
        issuer_id: "#{APP_STORE_CONNECT_API_KEY_ISSUER_ID}",
        key_content: "#{APP_STORE_CONNECT_API_KEY_CONTENT}"
      )

      # âœ… CI í™˜ê²½ ì„¤ì •
      # CI/CD í™˜ê²½ì—ì„œ í•„ìš”í•œ ê¸°ë³¸ ì„¤ì • ìˆ˜í–‰ (ì˜ˆ: Xcode ì„¤ì •, í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë“±)
      setup_ci

      # âœ… ì½”ë“œ ì„œëª… ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ê´€ë¦¬
      # matchë¥¼ ì‚¬ìš©í•˜ì—¬ Apple Developer ê³„ì •ì—ì„œ ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ì„ ê°€ì ¸ì˜´
      match(
        storage_mode: "git",
        type: "appstore",
        app_identifier: ["com.ukseung.Fastlane"],
        readonly: false,
        git_basic_authorization: Base64.strict_encode64("#{GIT_PERSONAL_TOKEN}"),
        generate_apple_certs: false
      )
      
      # âœ… ë¹Œë“œ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (ë…„ì›”ì¼ì‹œë¶„ì´ˆ ê¸°ë°˜)
      # Fastlaneì˜ increment_build_numberë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ ë²ˆí˜¸ë¥¼ ìë™ ì¦ê°€ì‹œí‚´
      increment_build_number(
        xcodeproj: "Fastlane-Example.xcodeproj",
        build_number: date_based_build_number
      )

      # âœ… í”„ë¡œì íŠ¸ì˜ íŒ€ ID ì—…ë°ì´íŠ¸
      # Xcode í”„ë¡œì íŠ¸ì˜ íŒ€ IDë¥¼ ì„¤ì •í•˜ì—¬ ì½”ë“œ ì„œëª… ì˜¤ë¥˜ ë°©ì§€
      update_project_team(
        path: "../Fastlane-Example/Fastlane-Example.xcodeproj",
        teamid: "#{TEAM_ID}"
      )

      # âœ… ì•± ë¹Œë“œ ë° Export
      # Xcode í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  .ipa íŒŒì¼ì„ ìƒì„±í•˜ì—¬ TestFlightì— ì—…ë¡œë“œ ì¤€ë¹„
      build_app(
        workspace: "Fastlane-Example.xcworkspace",
        scheme: "Fastlane-Example",
        export_method: "app-store",
        export_options: {
          method: "app-store",
          signingStyle: "manual",
          provisioningProfiles: {
            "com.ukseung.Fastlane" => "match AppStore com.ukseung.Fastlane"
          }
        }
      )

      # âœ… TestFlight ì—…ë¡œë“œ
      # ë¹Œë“œí•œ .ipa íŒŒì¼ì„ TestFlightì— ì—…ë¡œë“œ
      upload_to_testflight(skip_waiting_for_build_processing: true)

      # âœ… Slack ì•Œë¦¼ ì „ì†¡ (ì„±ê³µ)
      # TestFlight ì—…ë¡œë“œ ì„±ê³µ ì‹œ Slackìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡
      send_slack_message("âœ… TestFlight ë°°í¬ ëìŠµë‹ˆë‹¤ ğŸ˜")

    rescue => error
      # âŒ TestFlight ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
      # ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ Slackìœ¼ë¡œ ì „ì†¡í•˜ê³ , Fastlaneì— ì˜¤ë¥˜ë¥¼ ì „ë‹¬í•˜ì—¬ ì‹¤í–‰ ì¤‘ë‹¨
      send_slack_message("âŒ TestFlight ë°°í¬ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜­\nError: #{error}", false)
      raise error # ì‹¤íŒ¨ë¥¼ Fastlaneì— ì „ë‹¬
    end
  end

    # âœ… App Store ë°°í¬ Lane
    lane :release_app_store do
      begin
	# âœ… App Store Connect API í‚¤ ì„¤ì •
        app_store_connect_api_key(
          key_id: "#{APP_STORE_CONNECT_API_KEY_KEY_ID}",
          issuer_id: "#{APP_STORE_CONNECT_API_KEY_ISSUER_ID}",
          key_content: "#{APP_STORE_CONNECT_API_KEY_CONTENT}"
        )
  
	# âœ… CI í™˜ê²½ ì„¤ì •
        # CI/CD í™˜ê²½ì—ì„œ í•„ìš”í•œ ê¸°ë³¸ ì„¤ì • ìˆ˜í–‰ (ì˜ˆ: Xcode ì„¤ì •, í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë“±)
        setup_ci
  
	# âœ… ì½”ë“œ ì„œëª… ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ê´€ë¦¬
        # matchë¥¼ ì‚¬ìš©í•˜ì—¬ Apple Developer ê³„ì •ì—ì„œ ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ì„ ê°€ì ¸ì˜´
        match(
          storage_mode: "git",
          type: "appstore",
          app_identifier: ["com.ukseung.Fastlane"],
          readonly: false,
          git_basic_authorization: Base64.strict_encode64("#{GIT_PERSONAL_TOKEN}"),
          generate_apple_certs: false
        )
  
	# âœ… ë¹Œë“œ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (ë…„ì›”ì¼ì‹œë¶„ì´ˆ ê¸°ë°˜)
        # Fastlaneì˜ increment_build_numberë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ ë²ˆí˜¸ë¥¼ ìë™ ì¦ê°€ì‹œí‚´
        increment_build_number(
          xcodeproj: "Fastlane-Example.xcodeproj",
          build_number: date_based_build_number
        )
  
	# âœ… í”„ë¡œì íŠ¸ì˜ íŒ€ ID ì—…ë°ì´íŠ¸
        # Xcode í”„ë¡œì íŠ¸ì˜ íŒ€ IDë¥¼ ì„¤ì •í•˜ì—¬ ì½”ë“œ ì„œëª… ì˜¤ë¥˜ ë°©ì§€
        update_project_team(
          path: "../Fastlane-Example/Fastlane-Example.xcodeproj",
          teamid: "#{TEAM_ID}"
        )
  
        # âœ… ì•± ë¹Œë“œ ë° Export
        # Xcode í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  .ipa íŒŒì¼ì„ ìƒì„±í•˜ì—¬ TestFlightì— ì—…ë¡œë“œ ì¤€ë¹„
        build_app(
          workspace: "Fastlane-Example.xcworkspace",
          scheme: "Fastlane-Example",
          export_method: "app-store",
          export_options: {
            method: "app-store",
            signingStyle: "manual",
            provisioningProfiles: {
              "com.ukseung.Fastlane" => "match AppStore com.ukseung.Fastlane"
            }
          }
        )
  
        # âœ… ì•±ìŠ¤í† ì–´ ì—…ë¡œë“œ ğŸ‰
        deliver(
          submit_for_review: true,
          force: true,
          skip_screenshots: true,
          automatic_release: true,
          precheck_include_in_app_purchases: false,
          copyright: "Â© #{Time.now.year} COMPANY-NAME, Inc.",
          release_notes: {
            "en-US" => "WHATS NEW"
          },
          app_review_information: {
            demo_user: "demo@user.net",
            demo_password: "DEMO-PASSWORD"
          },
          submission_information: {    
            export_compliance_encryption_updated: false,
            export_compliance_uses_encryption: false,
            add_id_info_uses_idfa: false
          }
        )
  
        send_slack_message("âœ… App Store ë°°í¬ ì™„ë£Œ ğŸ˜")
      rescue => error
        send_slack_message("âŒ App Store ë°°í¬ ì‹¤íŒ¨ ğŸ˜­\nError: #{error}", false)
        raise error
      end
    end

  # âœ… Slack ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
  def send_slack_message(message, success = true)
    version = get_version_number(xcodeproj: "Fastlane-Example.xcodeproj") # Xcode í”„ë¡œì íŠ¸ì˜ ë²„ì „ ê°€ì ¸ì˜¤ê¸°

    full_message = "iOS #{version}(#{date_based_build_number})\n\n#{message}"

    slack(
      message: full_message,
      success: success,
      slack_url: "#{SLACK_URL}"
    )
  end

  # âœ… ë‚ ì§œ ê¸°ë°˜ ë¹Œë“œ ë²ˆí˜¸ ìƒì„± í•¨ìˆ˜
  def date_based_build_number
    Time.now.in_time_zone("Asia/Seoul").strftime("%Y.%m%d.%H%M")
  end
end
