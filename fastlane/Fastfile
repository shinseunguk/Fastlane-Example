# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

fastlane_require 'active_support'
fastlane_require 'active_support/core_ext/time'
fastlane_require 'dotenv'

#âœ… ìƒìˆ˜

SLACK_URL = ENV['SLACK_URL']

KEYCHAIN_NAME = ENV['KEYCHAIN_NAME']
KEYCHAIN_PASSWORD = ENV['KEYCHAIN_PASSWORD']

APP_IDENTIFIER = ENV['APP_IDENTIFIER']

MATCH_GIT_BASIC_AUTHORIZATION = ENV['MATCH_GIT_BASIC_AUTHORIZATION']

APP_STORE_CONNECT_API_KEY_KEY_ID = ENV['APP_STORE_CONNECT_API_KEY_KEY_ID']
APP_STORE_CONNECT_API_KEY_ISSUER_ID = ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID']
APP_STORE_CONNECT_API_KEY_KEY = ENV['APP_STORE_CONNECT_API_KEY_KEY']
APP_STORE_CONNECT_API_KEY


default_platform(:ios)

platform :ios do
  lane :beta do
    begin
      app_store_connect_api_key(
        key_id: "#{APP_STORE_CONNECT_API_KEY_KEY_ID}",
        issuer_id: "#{APP_STORE_CONNECT_API_KEY_ISSUER_ID}",
        key_content: "-----BEGIN PRIVATE KEY-----
        MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgD02o/Pu3bWBADqux
        +jjmR+gdnvd3u8coIJegzO8GyV+gCgYIKoZIzj0DAQehRANCAARricPXcG8oLm/j
        JmO8v8ho/9dqUe6eGYMMPJJcPGV38ejv4BBlPMnTEQy2HTAlCKztD26fDy2EU6LL
        qIQbFsKG
        -----END PRIVATE KEY-----"
      )

      pilot

      match(type: "appstore")
      sync_code_signing(type: "appstore")
      
      # ë¹Œë“œë²ˆí˜¸(ë…„ì›”ì¼ì‹œë¶„ì´ˆ)
      increment_build_number(xcodeproj: "Fastlane-Example.xcodeproj", build_number: date_based_build_number)

      # ì•± ë¹Œë“œ ë° TestFlight ì—…ë¡œë“œ
      build_app(
        workspace: "Fastlane-Example.xcworkspace",
        scheme: "Fastlane-Example"
      )
      upload_to_testflight
      # ì„±ê³µ ë©”ì‹œì§€
      send_slack_message("âœ… TestFlight ë°°í¬ ëìŠµë‹ˆë‹¤ ğŸ˜")
    rescue => error
      # ì‹¤íŒ¨ ë©”ì‹œì§€
      send_slack_message("âŒ TestFlight ë°°í¬ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜­\nError: #{error}", false)
      raise error # ì‹¤íŒ¨ë¥¼ Fastlaneì— ì „ë‹¬
    end
  end

  def send_slack_message(message, success = true)
    version = get_version_number(xcodeproj: "Fastlane-Example.xcodeproj") # Xcode í”„ë¡œì íŠ¸ì˜ ë²„ì „ ê°€ì ¸ì˜¤ê¸°

    full_message = "iOS #{version}(#{date_based_build_number})\n\n#{message}"

    slack(
      message: full_message,
      success: success,
      slack_url: "#{SLACK_URL}"
    )
  end

  def date_based_build_number
    Time.now.in_time_zone("Asia/Seoul").strftime("%Y.%m%d.%H%M")
  end

  lane :asd do
    print("----------------------------\n")
    print("#{MATCH_GIT_BASIC_AUTHORIZATION}\n")
    print("#{APP_IDENTIFIER}\n")
    print("#{KEYCHAIN_PASSWORD}\n")
    print("----------------------------")
  end
end
